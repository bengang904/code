<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>code ç¼–è¾‘å™¨</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/addon/dialog/dialog.min.css"> 
<style>
/* CSS æ ·å¼å¼€å§‹ - (ä¿æŒä¸ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸€è‡´) */
body {
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    font-family: "Segoe UI", sans-serif;
    background: #1e1e1e;
    color: #d4d4d4;
    border: 3px solid transparent; 
}
body.drag-over {
    border-color: #0e639c;
}

/* æ»šåŠ¨æ¡ç¾åŒ–æ ·å¼ */
::-webkit-scrollbar {
    width: 10px;
    height: 10px; 
}
::-webkit-scrollbar-track {
    background: #252526; 
}
::-webkit-scrollbar-thumb {
    background: #555; 
    border-radius: 5px;
    border: 2px solid #252526; 
}
::-webkit-scrollbar-thumb:hover {
    background: #777; 
}
#sidebar, #terminal, .CodeMirror-scroll {
    scrollbar-color: #555 #252526; 
    scrollbar-width: thin; 
}
#sidebar {
    background: #252526;
}

/* --- å¸ƒå±€å’Œèœå•æ ·å¼ --- */
.topbar {
    height: 40px;
    background: #333;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 10px;
    font-size: 14px;
    border-bottom: 1px solid #444;
    position: relative;
    z-index: 10;
}
.topbar .menu-left {
    display: flex;
    align-items: center;
}
.topbar .menu-left>div {
    margin-right: 20px;
    position: relative;
}
.topbar .menu-left>div>span {
    cursor: pointer;
    padding: 5px 0;
}
.topbar .menu-left>div>span:hover {
    color: #0e639c;
}
.submenu {
    display: none;
    position: absolute;
    top: 35px;
    left: 0;
    background: #252526;
    border: 1px solid #444;
    min-width: 150px;
    box-shadow: 0 4px 8px rgba(0,0,0,.3);
    padding: 5px 0;
    z-index: 20;
}
.submenu a {
    display: block;
    padding: 5px 15px;
    text-decoration: none;
    color: #d4d4d4;
    cursor: pointer;
}
.submenu a:hover {
    background: #0e639c;
    color: white;
}
.topbar .menu-left>div.menu-open .submenu {
    display: block;
}
#run-btn {
    background: #0e639c;
    color: white;
    border: none;
    border-radius: 3px;
    padding: 3px 10px;
    cursor: pointer;
    font-weight: bold;
}
#run-btn:hover {
    background: #1177bb;
}
/* ç¦ç”¨æ—¶çš„æ ·å¼ */
#run-btn:disabled {
    background: #444;
    cursor: not-allowed;
    color: #999;
}

.main-content {
    flex: 1;
    display: flex;
    overflow: hidden;
}
.sidebar-wrapper {
    position: relative;
    width: 250px;
    min-width: 50px;
    max-width: 80%;
    display: flex;
    flex-direction: column;
}
.sidebar-resizer {
    right: -3px;
    top: 0;
    bottom: 0;
    width: 6px;
    cursor: col-resize;
    position: absolute;
    z-index: 15;
    background: transparent;
}
#sidebar {
    flex: 1;
    overflow-y: auto;
    padding: 10px 0;
    font-size: 13px;
    user-select: none;
    background: #252526;
}

/* --- æ–‡ä»¶æ ‘æ ·å¼ --- */
.project-structure {
    list-style: none;
    padding: 0; 
    margin: 0;
    font-size: 13px;
}
.project-structure li {
    display: block; 
    cursor: pointer;
    white-space: nowrap;
    padding: 0; 
    position: relative;
    user-select: text; 
}
.project-structure li:hover .folder-title,
.project-structure li.icon-file:hover {
    background: #3c3c3c;
}

.folder-title {
    display: flex;
    align-items: center;
    padding: 2px 5px;
}

.icon-folder > .folder-title::before { 
    content: 'ğŸ“ ';
    width: 20px; 
    display:inline-block; 
    text-align:center; 
    margin-right: -4px; 
}
li.icon-file {
    display: flex;
    align-items: center;
    padding: 2px 5px;
}
.folder-toggle {
    width: 16px;
    display: inline-block;
    text-align: center;
    margin-right: 4px; 
    color: #999;
    cursor: pointer;
    font-family: inherit;
    font-weight: normal; 
}
.folder-toggle::before { content: 'â–¶'; }
li.folder-open > .folder-title > .folder-toggle::before { content: 'â–¼'; }
.folder-content {
    list-style: none;
    padding-left: 0; 
    margin: 0;
    display: none;
    width: 100%;
    padding-left: 16px; 
}
li.folder-open > .folder-content { display: block; }
.icon-file::before { 
    line-height: 1.2;
    content: 'ğŸ“„ '; 
    width: 20px; 
    display:inline-block; 
    text-align:center; 
    margin-right:5px; 
}
.icon-file[data-name$=".js"]::before, 
.icon-file[data-name$=".ts"]::before {
    content: 'JS';
    color: #1e1e1e;
    background: #f9e64e;
    font-weight: bold;
    font-size: 11px;
    line-height: 1.2;
    border-radius: 2px;
    padding: 1px 2px;
    margin-right: 5px;
}
.icon-file[data-name$=".py"]::before {
    content: 'ğŸ ';
    color: #3776ab;
    background: none;
    padding: 0;
    margin-right: 4px;
}
.icon-file[data-name$=".html"]::before {
    content: ' </> ';
    color: #e34c26;
    background: none;
    padding: 0;
    margin-right: 4px;
}

/* --- ç¼–è¾‘å™¨å’Œç»ˆç«¯æ ·å¼ --- */
.editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}
.tabs-bar {
    display: flex;
    height: 30px;
    background: #1e1e1e;
    border-bottom: 1px solid #3c3c3c;
    overflow-x: auto;
}
.tab {
    padding: 5px 10px;
    font-size: 12px;
    cursor: pointer;
    border-right: 1px solid #3c3c3c;
    background: #252526;
    color: #999;
    display: flex;
    align-items: center;
    flex-shrink: 0;
    user-select: none;
}
.tab.active {
    background: #1e1e1e;
    color: #d4d4d4;
}
.tab .close-btn {
    margin-left: 8px;
    font-weight: bold;
    color: #999;
}
.tab .close-btn:hover {
    color: #d4d4d4;
}
.editor-wrapper {
    flex: 1;
    position: relative;
}
.editor {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
}
.editor.active { display: block; }
.CodeMirror { height: 100%; }
#terminal-wrapper {
    position: relative;
    height: 150px;
    min-height: 30px;
    max-height: 80%;
}
.terminal-resizer {
    top: -3px;
    left: 0;
    right: 0;
    height: 6px;
    cursor: row-resize;
    position: absolute;
    z-index: 15;
    background: transparent;
}
#terminal {
    height: 100%;
    background: #1e1e1e;
    border-top: 1px solid #333;
    color: #d4d4d4;
    padding: 5px;
    font-family: monospace;
    overflow: auto;
    white-space: pre-wrap;
}
.no-select { user-select: none; }
.resizing-h { cursor: col-resize; }
.resizing-v { cursor: row-resize; }
/* CodeMirror å¯¹è¯æ¡†æ ·å¼ä¿®æ­£ */
.CodeMirror-dialog {
    background: #1e1e1e;
    color: #d4d4d4;
    border-top: 1px solid #333;
    padding: 4px;
    font-size: 14px;
}
.CodeMirror-dialog label {
    margin-right: 10px;
}
.CodeMirror-dialog input[type=text] {
    background: #333;
    border: 1px solid #444;
    color: #d4d4d4;
    padding: 2px 4px;
}
/* CSS æ ·å¼ç»“æŸ */
</style>
</head>
<body>
<div class="topbar">
    <div class="menu-left">
        <div id="file-menu-item"><span>æ–‡ä»¶</span>
            <div class="submenu">
                <a id="new-file-btn">æ–°å»ºæ–‡ä»¶</a>
                <a id="open-file-btn">æ‰“å¼€æ–‡ä»¶</a>
                <a id="save-file-btn">ä¿å­˜ (Ctrl+S)</a>
                <a id="close-tab-btn">å…³é—­æ–‡ä»¶</a>
                <a id="save-as-btn">å¦å­˜ä¸º...</a>
                <hr style="margin:5px 0;border-color:#444">
                <a id="import-folder-btn">æ‰“å¼€æ–‡ä»¶å¤¹...</a>
            </div>
        </div>
        <div id="edit-menu-item"><span>ç¼–è¾‘</span>
            <div class="submenu">
                <a id="undo-btn">æ’¤é”€ (Ctrl+Z)</a>
                <a id="redo-btn">æ¢å¤ (Ctrl+Y)</a>
                <hr style="margin:5px 0;border-color:#444">
                <a id="select-all-btn">å…¨é€‰ (Ctrl+A)</a>
                <a id="cut-btn">å‰ªåˆ‡ (Ctrl+X)</a>
                <a id="copy-btn">å¤åˆ¶ (Ctrl+C)</a>
                <a id="paste-btn">ç²˜è´´ (Ctrl+V)</a>
                <hr style="margin:5px 0;border-color:#444">
                <a id="find-btn">æŸ¥æ‰¾ (Ctrl+F)</a>
                <a id="replace-btn">æ›¿æ¢ (Ctrl+H)</a>
            </div>
        </div>
    </div>
    <button id="run-btn" disabled>â–¶ è¿è¡Œ</button>
</div>

<div class="main-content">
    <div class="sidebar-wrapper">
        <div id="sidebar">
            <div style="padding:0 10px;font-weight:bold;margin-bottom:5px">é¡¹ç›®ç»“æ„</div>
            <ul id="project-tree" class="project-structure"></ul>
        </div>
        <div id="sidebar-resizer" class="sidebar-resizer"></div>
    </div>

    <div class="editor-container">
        <div id="tabs-bar" class="tabs-bar"></div>
        <div id="editor-wrapper" class="editor-wrapper"></div>
        <div id="terminal-wrapper">
            <div id="terminal-resizer" class="terminal-resizer"></div>
            <div id="terminal"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/addon/search/matchesonscrollbar.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

<script>
// ========== å…¨å±€å˜é‡/å¸¸é‡ ==========
let pyodideReady = false;
let pyodide;
const terminal = document.getElementById("terminal");
const runBtn = document.getElementById("run-btn");
const fileMenuItem = document.getElementById('file-menu-item');
const editMenuItem = document.getElementById('edit-menu-item');
const sidebarWrapper = document.querySelector('.sidebar-wrapper');
const editorContainer = document.querySelector('.editor-container');
const tabsBar = document.getElementById('tabs-bar');
const editorWrapper = document.getElementById('editor-wrapper');
const terminalWrapper = document.getElementById('terminal-wrapper');
const bodyElement = document.body; 
let currentDirectoryHandle = null;
let openedFiles = {};
let fileHandlesCache = {};
let activeFileId = null;
let fileCounter = 1;
let appClipboard = ""; 

// Pyodide åŒ…åˆ—è¡¨ (æ¯æ¬¡éƒ½å°è¯•åŠ è½½/åˆå§‹åŒ–)
const PACKAGES_TO_LOAD = ['numpy', 'scipy', 'pandas', 'matplotlib']; 

const PYTHON_TEMPLATE = '# Python è„šæœ¬\nprint("Hello, Pyodide!")\n# å°è¯•ä½¿ç”¨ Pandas æˆ– NumPyï¼š\n# import pandas as pd\n# import numpy as np\n# print(pd.Series(np.array([1, 2, 3])))';
const DEFAULT_TEMPLATE = '// æ–°å»ºæ–‡ä»¶\n';

const WELCOME_FILE_NAME = 'README.txt';
const WELCOME_CONTENT = `æ¬¢è¿ä½¿ç”¨åœ¨çº¿ code ç¼–è¾‘å™¨ï¼

1. Pyodide (Python ç¯å¢ƒ) æ­£åœ¨ç»ˆç«¯ä¸­åŠ è½½ã€‚å®ƒå°†å°è¯•åœ¨å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰ç§‘å­¦è®¡ç®—åº“ã€‚
2. æ‚¨å¯ä»¥åœ¨å·¦ä¾§æ–‡ä»¶èœå•ä¸­æ–°å»ºæˆ–æ‰“å¼€æ–‡ä»¶ã€‚
3. æŒ‰ "â–¶ è¿è¡Œ" ã€‚

Enjoy!`;
const WELCOME_FILE_ID = 'welcome_readme_doc'; 


// ========== å·¥å…·å‡½æ•°ï¼šä»…ç”¨äº Pyodide/Python ç›¸å…³æ—¥å¿— ==========
function logTerminal(message) {
    terminal.textContent += message + "\n";
    terminal.scrollTop = terminal.scrollHeight;
}

function closeMenu(){ 
    fileMenuItem.classList.remove('menu-open'); 
    editMenuItem.classList.remove('menu-open');
}
function closeMenuAndExecute(callback){ closeMenu(); if(callback) callback(); }
function getActiveEditor(){ return activeFileId ? openedFiles[activeFileId].editor : null; }


// ========== Pyodide (ä¿®æ”¹åŠ è½½é€»è¾‘: å¼ºåˆ¶åŠ è½½åŒ…) ==========
async function loadPyodideWithPackages(){
    logTerminal("æ­£åœ¨åŠ è½½ Python æ ¸å¿ƒç¯å¢ƒ...");
    runBtn.disabled = true; // åŠ è½½å¼€å§‹ï¼šç¦ç”¨è¿è¡ŒæŒ‰é’®

    // æ ¸å¿ƒ Pyodide åŠ è½½
    pyodide = await loadPyodide({
        stdout: logTerminal,
        stderr: logTerminal
    });
    
    // **æ¯æ¬¡éƒ½å¼ºåˆ¶åŠ è½½é¢å¤–åŒ…**
    logTerminal(`æ­£åœ¨åŠ è½½/åˆå§‹åŒ–é¢å¤–åŒ…: ${PACKAGES_TO_LOAD.join(', ')}... (è¯·ç­‰å¾…...)`);
    try {
        // ä½¿ç”¨ loadPackage åŠ è½½æ‰€æœ‰åŒ…
        // Pyodide ä¼šæ™ºèƒ½åœ°æ£€æŸ¥æ˜¯å¦å·²å®‰è£…ï¼Œå¦‚æœå®‰è£…äº†åˆ™åªæ˜¯åˆå§‹åŒ–
        await pyodide.loadPackage(PACKAGES_TO_LOAD, logTerminal);
        logTerminal("æ‰€æœ‰ Python åº“åŠ è½½å®Œæˆã€‚");
    } catch (error) {
        logTerminal(`åŠ è½½ Python åº“æ—¶å‡ºé”™ï¼š${error}. è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚`);
    }

    pyodideReady = true;
    logTerminal("Python ç¯å¢ƒå·²å°±ç»ª âœ…");
    runBtn.disabled = false; // åŠ è½½å®Œæˆï¼šå¯ç”¨è¿è¡ŒæŒ‰é’®
}

function openWelcomeFile() {
    if (openedFiles[WELCOME_FILE_ID]) {
        switchTab(WELCOME_FILE_ID);
    } else {
        openFileInTab(WELCOME_FILE_NAME, WELCOME_CONTENT, null, WELCOME_FILE_ID); 
    }
}


// ========== æ–‡ä»¶ä¸æ ‡ç­¾ (ä¿æŒä¸å˜) ==========
function openFileInTab(name, content, fileHandle=null, providedFileId=null){
    
    const fileId = providedFileId || `file-${fileCounter++}`;
    
    if(openedFiles[fileId]){ switchTab(fileId); return; }
    
    const isPython = name.toLowerCase().endsWith('.py') || (!name.includes('.') && content===PYTHON_TEMPLATE); 
    const editorDiv = document.createElement('div');
    editorDiv.className = 'editor';
    editorDiv.id = `editor-${fileId}`;
    editorWrapper.appendChild(editorDiv);
    
    const editor = CodeMirror(editorDiv,{
        value: content,
        mode: isPython?"python":"text/plain",
        theme:"dracula",
        lineNumbers:true,
        indentUnit:4,
        tabSize:4,
        extraKeys: {"Ctrl-Space": "autocomplete"},
        matchBrackets: true 
    });
    
    const tab = document.createElement('div');
    tab.className = 'tab';
    tab.id = `tab-${fileId}`;
    tab.innerHTML = `<span>${name}</span><span class="close-btn" data-file-id="${fileId}">&times;</span>`;
    tabsBar.appendChild(tab);
    
    openedFiles[fileId] = { name, editor, fileHandle, tab, isSaved: !!fileHandle };
    
    tab.addEventListener('click', e=>{
        if(e.target.classList.contains('close-btn')){ closeTab(fileId); }
        else{ switchTab(fileId); }
    });
    switchTab(fileId);
}

function switchTab(fileId){
    if(!openedFiles[fileId] || activeFileId===fileId) return;
    
    if(activeFileId){
        const prevFile = openedFiles[activeFileId];
        if (prevFile) { 
            prevFile.tab.classList.remove('active');
            const currentEditorDiv = document.getElementById(`editor-${activeFileId}`);
            if(currentEditorDiv) currentEditorDiv.classList.remove('active');
        }
    }
    
    activeFileId = fileId;
    openedFiles[activeFileId].tab.classList.add('active');
    const nextEditorDiv = document.getElementById(`editor-${activeFileId}`);
    if(nextEditorDiv) {
        nextEditorDiv.classList.add('active');
        getActiveEditor().refresh();
    }
}

function closeTab(fileId){
    if(!openedFiles[fileId]) return;
    const f = openedFiles[fileId];
    
    const isActive = activeFileId===fileId;
    
    f.tab.remove();
    document.getElementById(`editor-${fileId}`).remove(); 
    
    delete openedFiles[fileId];
    
    if(isActive){
        activeFileId = null; 
        
        const remaining = Object.keys(openedFiles);
        if(remaining.length>0){ 
            switchTab(remaining[remaining.length-1]); 
        }
    }
}

// ========== ç¼–è¾‘å™¨åŠŸèƒ½å®ç° (ä¿æŒä¸å˜) ==========

// æ’¤é”€/æ¢å¤
document.getElementById('undo-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{
    const editor = getActiveEditor();
    if(editor) editor.undo();
}));

document.getElementById('redo-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{
    const editor = getActiveEditor();
    if(editor) editor.redo();
}));

// å…¨é€‰
document.getElementById('select-all-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{
    const editor = getActiveEditor();
    if(editor) editor.execCommand("selectAll");
}));

// å¤åˆ¶ (Copy) - å­˜å…¥åº”ç”¨å†…å­˜
document.getElementById('copy-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{
    const editor = getActiveEditor();
    if (!editor) { return; }
    const selectedText = editor.getSelection();
    if (selectedText) {
        appClipboard = selectedText; 
    }
}));

// å‰ªåˆ‡ (Cut) - å­˜å…¥åº”ç”¨å†…å­˜ + åˆ é™¤
document.getElementById('cut-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{
    const editor = getActiveEditor();
    if (!editor) { return; }
    
    const selectedText = editor.getSelection();
    if (!selectedText) {
        return;
    }

    appClipboard = selectedText;
    
    if (editor.somethingSelected()) {
        editor.replaceSelection("", "around");
    }
}));

// ç²˜è´´ (Paste) - ä»åº”ç”¨å†…å­˜åŠ è½½
document.getElementById('paste-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{
    const editor = getActiveEditor();
    if (!editor) { return; }

    if (appClipboard) {
        editor.replaceSelection(appClipboard);
    }
}));

// æŸ¥æ‰¾ (Find) - è°ƒç”¨ CodeMirror å‘½ä»¤
document.getElementById('find-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{
    const editor = getActiveEditor();
    if(editor) {
        editor.execCommand("findPersistent"); 
    }
}));

// æ›¿æ¢ (Replace) - è°ƒç”¨ CodeMirror å‘½ä»¤
document.getElementById('replace-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{
    const editor = getActiveEditor();
    if(editor) {
        editor.execCommand("replace"); 
    }
}));


// ========== æ–‡ä»¶æ“ä½œ (ä¿æŒä¸å˜) ==========
async function writeFile(fileHandle, contents, fileName){
    const writable = await fileHandle.createWritable();
    await writable.write(contents);
    await writable.close();
    openedFiles[activeFileId].isSaved = true;
}
async function openFileFromHandle(fileHandle){
    try{
        const file = await fileHandle.getFile();
        const contents = await file.text();
        openFileInTab(file.name, contents, fileHandle); 
    }catch(err){ 
        /* å¿½ç•¥é”™è¯¯ */
    }
}
async function saveActiveFile() {
    const f = openedFiles[activeFileId]; 
    if(!f) { return; }
    const contents = f.editor.getValue();
    if(f.fileHandle){ 
        await writeFile(f.fileHandle, contents, f.name); 
    } else { 
        document.getElementById('save-as-btn').click(); 
    }
}

// ========== èœå•äº‹ä»¶ (ä¿æŒä¸å˜) ==========
document.getElementById('new-file-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{
    let fileName = prompt("é€‰æ‹©.pyæ–‡ä»¶ç±»å‹ï¼Œæˆ–è¾“å…¥æ–‡ä»¶å","untitled.py"); 
    if(!fileName) return;
    fileName = fileName.trim();
    if(fileName===""){ return; }
    
    let template = DEFAULT_TEMPLATE;
    let ext = fileName.split('.').pop().toLowerCase();
    if(ext==='py') template = PYTHON_TEMPLATE; 

    openFileInTab(fileName, template); 
}));
document.getElementById('close-tab-btn').addEventListener('click', ()=>closeMenuAndExecute(()=>{ if(activeFileId) closeTab(activeFileId); }));
document.getElementById('open-file-btn').addEventListener('click', ()=>closeMenuAndExecute(async ()=>{
    try{
        const [fileHandle] = await window.showOpenFilePicker();
        await openFileFromHandle(fileHandle);
    }catch(err){ 
        if(err.name!=='AbortError'){ /* å¿½ç•¥é”™è¯¯ */ }
    }
}));
document.getElementById('save-file-btn').addEventListener('click', ()=>closeMenuAndExecute(saveActiveFile)); 
document.getElementById('save-as-btn').addEventListener('click', ()=>closeMenuAndExecute(async ()=>{
    const f = openedFiles[activeFileId]; if(!f) return;
    try{
        const suggestedName = f.fileHandle ? f.fileHandle.name : f.name;
        let types = [];
        const ext = suggestedName.split('.').pop().toLowerCase();
        if(ext === 'py') {
            types.push({description:'Python Files', accept:{'text/x-python':['.py']}});
        } else if(ext === 'txt') {
            types.push({description:'Text Files', accept:{'text/plain':['.txt']}});
        }
        
        const handle = await window.showSaveFilePicker({suggestedName:suggestedName, types: types});
        const contents = f.editor.getValue();
        await writeFile(handle, contents, handle.name);
        
        f.fileHandle = handle;
        f.name = handle.name;
        f.tab.querySelector('span').textContent = handle.name;
    }catch(err){ 
        if(err.name!=='AbortError') { /* å¿½ç•¥é”™è¯¯ */ }
    }
}));

// ========== è¿è¡ŒæŒ‰é’® (ä¿æŒä¸å˜) ==========
document.getElementById("run-btn").addEventListener("click", async ()=>{
    const editor = getActiveEditor();
    if(!editor){ return; }
    const code = editor.getValue();
    if(!pyodideReady){ 
        logTerminal("Python ç¯å¢ƒåŠ è½½ä¸­ï¼Œè¯·ç¨ç­‰..."); 
        return; 
    }
    logTerminal("\n>>> æ­£åœ¨è¿è¡Œä»£ç ...");
    try{
        await pyodide.runPythonAsync(code);
    }catch(err){ 
        logTerminal(err);
    }
});

// ========== æ–‡ä»¶å¤¹å¯¼å…¥å’Œæ ‘ (ä¿æŒä¸å˜) ==========
document.getElementById('import-folder-btn').addEventListener('click', ()=>closeMenuAndExecute(async ()=>{
    try{
        currentDirectoryHandle = await window.showDirectoryPicker();
        fileHandlesCache = {};
        fileHandlesCache[currentDirectoryHandle.name] = currentDirectoryHandle; 
        await renderProjectTree(currentDirectoryHandle, document.getElementById('project-tree'), currentDirectoryHandle.name);
    }catch(err){ 
        if(err.name!=='AbortError'){ /* å¿½ç•¥é”™è¯¯ */ }
    }
}));

function getHandleByPath(path){ return fileHandlesCache[path] || null; }

async function renderProjectTree(handle, parentElement, path){
    parentElement.innerHTML = '';
    let items = [];
    for await(const entry of handle.values()){
        const fullPath = path + '/' + entry.name;
        fileHandlesCache[fullPath] = entry;
        items.push(entry);
    }
    items.sort((a,b)=>{
        if(a.kind==='directory' && b.kind!=='directory') return -1;
        if(a.kind!=='directory' && b.kind==='directory') return 1;
        return a.name.localeCompare(b.name);
    });
    for(const item of items){
        const fullPath = path+'/'+item.name;
        const li = document.createElement('li');
        li.setAttribute('data-path', fullPath);
        
        if(item.kind==='file'){
            li.className = 'icon-file';
            li.setAttribute('data-name', item.name);
            li.textContent = item.name;
            li.addEventListener('click', async e=>{ e.stopPropagation(); await openFileFromHandle(item); });
        }else if(item.kind==='directory'){
            li.className = 'icon-folder';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'folder-title';
            titleDiv.textContent = item.name;
            
            const toggle = document.createElement('span');
            toggle.className = 'folder-toggle';
            
            titleDiv.prepend(toggle);
            
            li.appendChild(titleDiv);
            
            const ul = document.createElement('ul');
            ul.className = 'folder-content';
            li.appendChild(ul); 
        }
        parentElement.appendChild(li);
    }
}

const projectTree = document.getElementById('project-tree');
projectTree.addEventListener('click', async e=>{
    const titleDiv = e.target.closest('.folder-title');
    if(!titleDiv) return;
    
    const folderLi = titleDiv.closest('li.icon-folder');
    if(!folderLi) return;
    
    const ul = folderLi.querySelector('.folder-content');
    const folderPath = folderLi.getAttribute('data-path');
    const handle = getHandleByPath(folderPath);
    if(!handle) return;
    
    const isOpen = folderLi.classList.toggle('folder-open');
    
    if(isOpen && ul.children.length===0){
        await renderProjectTree(handle, ul, folderPath);
    }
    e.stopPropagation();
});

// ========== èœå•æ‰“å¼€/å…³é—­ (ä¿æŒä¸å˜) ==========
fileMenuItem.addEventListener('click', e=>{
    editMenuItem.classList.remove('menu-open');
    if(e.target.tagName==='SPAN' || e.target===fileMenuItem) fileMenuItem.classList.toggle('menu-open');
    e.stopPropagation();
});

editMenuItem.addEventListener('click', e=>{
    fileMenuItem.classList.remove('menu-open');
    if(e.target.tagName==='SPAN' || e.target===editMenuItem) editMenuItem.classList.toggle('menu-open');
    e.stopPropagation();
});

document.addEventListener('click', closeMenu);

// ========== æ‹–æ”¾åŠŸèƒ½ (ä¿æŒä¸å˜) ==========
bodyElement.addEventListener('dragover', e => {
    e.preventDefault();
    bodyElement.classList.add('drag-over');
});

bodyElement.addEventListener('dragleave', e => {
    e.preventDefault();
    if(e.target === bodyElement) {
        bodyElement.classList.remove('drag-over');
    }
});

bodyElement.addEventListener('drop', async e => {
    e.preventDefault();
    bodyElement.classList.remove('drag-over');

    if (e.dataTransfer.items) {
        for (let i = 0; i < e.dataTransfer.items.length; i++) {
            const item = e.dataTransfer.items[i];
            if (item.kind === 'file') {
                try {
                    const file = item.getAsFile();
                    if (file) {
                        const contents = await file.text();
                        openFileInTab(file.name, contents, null); 
                    }
                } catch (err) {
                    /* å¿½ç•¥é”™è¯¯ */
                }
            }
        }
    }
});

// ========== Ctrl+S/Cmd+S å¿«æ·é”® (ä¿æŒä¸å˜) ==========
document.addEventListener('keydown', e => {
    const isModifierPressed = e.ctrlKey || e.metaKey; 
    const isSPressed = e.key === 's' || e.key === 'S';
    
    if (isModifierPressed && isSPressed) {
        e.preventDefault(); 
        saveActiveFile(); 
    }
});


// ========== è°ƒæ•´å¤§å° (ä¿æŒä¸å˜) ==========
const sidebarResizer=document.getElementById('sidebar-resizer');
const terminalResizer=document.getElementById('terminal-resizer');
let initialX, initialWidth, editorRect;

const doResizeH = e => {
    const deltaX = e.clientX - initialX;
    const newWidth = initialWidth + deltaX;
    sidebarWrapper.style.width = `${newWidth}px`;
    const activeEditor = getActiveEditor(); if(activeEditor) activeEditor.refresh();
};
const stopResizeH = ()=>{ document.removeEventListener('mousemove',doResizeH); document.removeEventListener('mouseup',stopResizeH); document.body.style.cursor='default'; document.body.classList.remove('no-select'); sidebarResizer.style.cursor='col-resize'; };
sidebarResizer.addEventListener('mousedown', e=>{
    initialX = e.clientX; initialWidth = sidebarWrapper.offsetWidth;
    document.addEventListener('mousemove', doResizeH); document.addEventListener('mouseup', stopResizeH);
    document.body.style.cursor='col-resize'; document.body.classList.add('no-select'); e.preventDefault();
});

const doResizeV = e => {
    const mainContentHeight=document.querySelector('.main-content').offsetHeight;
    const tabsBarHeight=tabsBar.offsetHeight;
    const newTerminalHeight=mainContentHeight-(e.clientY-editorContainer.getBoundingClientRect().top)-tabsBarHeight;
    terminalWrapper.style.height=`${newTerminalHeight}px`;
    const activeEditor = getActiveEditor(); if(activeEditor) activeEditor.refresh();
};
const stopResizeV = ()=>{ document.removeEventListener('mousemove',doResizeV); document.removeEventListener('mouseup',stopResizeV); document.body.style.cursor='default'; document.body.classList.remove('no-select'); terminalResizer.style.cursor='row-resize'; };
terminalResizer.addEventListener('mousedown', e=>{
    editorRect = editorContainer.getBoundingClientRect();
    document.addEventListener('mousemove', doResizeV); document.addEventListener('mouseup', stopResizeV);
    document.body.style.cursor='row-resize'; document.body.classList.add('no-select'); e.preventDefault();
});

// å¯åŠ¨åºåˆ—ï¼šå…ˆæ‰“å¼€è¯´æ˜æ–‡æ¡£ï¼Œå†åŠ è½½ Pyodide
openWelcomeFile();
loadPyodideWithPackages();
</script>
</body>
</html>
